name: Notify Release

on:
  workflow_run:
    workflows: ["Release Build"]
    types: [completed]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Fetch Latest Tag and Release Notes
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{github.repository}}/tags" | jq -r '.[0].name')
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/${{github.repository}}/releases/tags/$LATEST_TAG")
          
          echo "$RELEASE_DATA" | jq -r '.body' > release_notes.txt
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Get and Categorize Assets
        id: categorize
        run: |
          curl -s "https://api.github.com/repos/${{github.repository}}/releases/tags/${{ env.LATEST_TAG }}" -o release.json
          
          jq -r '.assets[] | "\(.browser_download_url) \(.size)"' release.json | while read -r URL SIZE; do
            NAME=$(basename "$URL")
            SIZE_HR=$(awk -v s="$SIZE" 'BEGIN{split("B KB MB GB",u); for(i=1;s>=1024&&i<4;i++)s/=1024; printf "%.2f %s",s,u[i]}')
            
            if [[ "$NAME" == *"arm64-v8a"* ]]; then echo "APK_ARM64=[Download]($URL) | $SIZE_HR" >> $GITHUB_ENV
            elif [[ "$NAME" == *"armeabi-v7a"* ]]; then echo "APK_V7A=[Download]($URL) | $SIZE_HR" >> $GITHUB_ENV
            elif [[ "$NAME" == *"x86_64"* ]]; then echo "APK_X64=[Download]($URL) | $SIZE_HR" >> $GITHUB_ENV
            elif [[ "$NAME" == *"-Setup.exe" ]]; then echo "WIN_EXE=[Download]($URL) | $SIZE_HR" >> $GITHUB_ENV
            elif [[ "$NAME" == *"Windows-Portable.zip" ]]; then echo "WIN_ZIP=[Download]($URL) | $SIZE_HR" >> $GITHUB_ENV
            elif [[ "$NAME" == *"Linux.zip" ]]; then echo "LINUX_ZIP=[Download]($URL) | $SIZE_HR" >> $GITHUB_ENV
            fi
          done

      - name: Send Discord Embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          NOTES=$(cat release_notes.txt | sed 's/||//g')
          
          # Mention @everyone or specific roles
          MENTION="@everyone"
          
          # Embed Data
          PAYLOAD=$(jq -nc \
            --arg mention "$MENTION" \
            --arg title "ðŸš€ New Release: ${{ env.LATEST_TAG }}" \
            --arg desc "$NOTES" \
            --arg color "1754309" \
            '{
              content: $mention,
              embeds: [{
                title: $title,
                description: $desc,
                color: ($color | tonumber),
                timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }]
            }')
          
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

      - name: Send Discord Asset Links
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MSG="ðŸ“¦ **Assets for ${{ env.LATEST_TAG }}**"$'\n'
          [ -n "$WIN_EXE" ] && MSG="${MSG}ðŸ”¹ **Windows Setup:** $WIN_EXE"$'\n'
          [ -n "$WIN_ZIP" ] && MSG="${MSG}ðŸ”¹ **Windows Portable:** $WIN_ZIP"$'\n'
          [ -n "$LINUX_ZIP" ] && MSG="${MSG}ðŸ”¹ **Linux Zip:** $LINUX_ZIP"$'\n'
          [ -n "$APK_ARM64" ] && MSG="${MSG}ðŸ”¹ **Android arm64:** $APK_ARM64"$'\n'
          [ -n "$APK_V7A" ] && MSG="${MSG}ðŸ”¹ **Android v7a:** $APK_V7A"$'\n'

          PAYLOAD=$(jq -n --arg content "$MSG" '{content: $content}')
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"