name: Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: 25.2.9519653

      - name: Install CMake 3.18.1
        run: |
          yes | sdkmanager "cmake;3.18.1"
          echo "cmake.dir=$ANDROID_HOME/cmake/3.18.1" >> $GITHUB_WORKSPACE/android/local.properties

      - name: Install dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          echo "ANILIST_CLIENT_ID=${{ secrets.ANILIST_CLIENT_ID }}" >> .env
          echo "ANILIST_CLIENT_SECRET=${{ secrets.ANILIST_CLIENT_SECRET }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env
        shell: bash

      - name: Build APK (split per ABI)
        run: flutter build apk --release --split-per-abi

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/*.apk

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libwebkit2gtk-4.1-dev libsecret-1-dev libasound2-dev libmpv-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: Install dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          echo "ANILIST_CLIENT_ID=${{ secrets.ANILIST_CLIENT_ID }}" >> .env
          echo "ANILIST_CLIENT_SECRET=${{ secrets.ANILIST_CLIENT_SECRET }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env
        shell: bash

      - name: Build Linux
        run: flutter build linux --release

      - name: Compress Linux Bundle
        run: |
          cd build/linux/x64/release/bundle
          zip -r ../../../../../ShonenX-Linux.zip .

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: ShonenX-Linux.zip

  publish-release:
    needs: [build-android, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apks
          path: android-apks

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: linux-bundle

      - name: Generate Changelog
        id: changelog
        run: |
          # Finds the tag before the one currently being pushed
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found. Generating log from initial commit."
            COMMITS=$(git log HEAD --pretty=format:'%s')
            echo "$COMMITS" > all_commits.txt
          else
            echo "Generating changelog from $PREVIOUS_TAG to HEAD"
            COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:'%s')
            echo "$COMMITS" > all_commits.txt
          fi

          # --- RELEASE TYPE WARNING ---
          TAG_NAME=${GITHUB_REF_NAME}
          WARNING_MSG=""

          if [[ "$TAG_NAME" == *"debug"* ]]; then
            WARNING_MSG="> [!WARNING]\n> **DEBUG BUILD**: This release is for debugging purposes only. It may be unstable and contain verbose logging."
          elif [[ "$TAG_NAME" == *"beta"* ]]; then
            WARNING_MSG="> [!IMPORTANT]\n> **BETA RELEASE**: This is a pre-release version for testing. Features may be incomplete or contain bugs."
          elif [[ "$TAG_NAME" == *"alpha"* ]]; then
            WARNING_MSG="> [!CAUTION]\n> **ALPHA RELEASE**: Highly experimental. Use with caution."
          elif [[ "$TAG_NAME" == *"hotfix"* ]]; then
            WARNING_MSG="> [!NOTE]\n> **HOTFIX**: Critical fixes applied on top of the previous release."
          fi

          if [ -n "$WARNING_MSG" ]; then
             echo -e "$WARNING_MSG\n" > release_notes.md
          else
             echo "" > release_notes.md
          fi
          # ---------------------------

          echo "## Changelog" >> release_notes.md
          extract_category() {
            local TYPE=$1
            local TITLE=$2
            local PATTERN="^$TYPE"
            
            # Count commits of this type
            COUNT=$(grep -i "$PATTERN" all_commits.txt | wc -l)
            
            if [ "$COUNT" -gt 0 ]; then
              echo "### $TITLE" >> release_notes.md
              grep -i "$PATTERN" all_commits.txt | sed "s/^$TYPE[: ]*//" | sed "s/^/- /" >> release_notes.md
              echo "" >> release_notes.md
            fi
          }

          extract_category "feat" "üöÄ Features"
          extract_category "fix" "üêõ Bug Fixes"
          extract_category "perf" "‚ö° Performance"
          extract_category "refactor" "‚ôªÔ∏è Refactor"
          extract_category "chore" "üîß Chores & Maintenance"
          
          # Add unmatched commits to "Other Changes" if desired, or skip.
          # For stricter conventional commits, the above covers most.
          
          # Read file content into variable safely
          RELEASE_BODY=$(cat release_notes.md)
          
          # Multiline output for GITHUB_OUTPUT
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-apks/*.apk
            linux-bundle/*.zip
          body: ${{ steps.changelog.outputs.notes }}
          token: ${{ secrets.GITHUB_TOKEN }}
