name: Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_windows:
        description: "Build Windows"
        required: false
        default: true
        type: boolean
      build_linux:
        description: "Build Linux"
        required: false
        default: true
        type: boolean
      build_android:
        description: "Build Android"
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-android:
    if: github.event_name == 'push' || github.event.inputs.build_android == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
      - uses: android-actions/setup-android@v3
        with:
          ndk-version: 29.0.14033849
      - name: Configure Android Build
        run: |
          yes | sdkmanager "cmake;3.18.1"
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "cmake.dir=$ANDROID_HOME/cmake/3.18.1" >> android/local.properties
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF
          cat <<EOF > keys.json
          {
            "ANILIST_CLIENT_ID": "${{ secrets.ANILIST_CLIENT_ID }}",
            "ANILIST_CLIENT_SECRET": "${{ secrets.ANILIST_CLIENT_SECRET }}",
            "MAL_CLIENT_ID": "${{ secrets.MAL_CLIENT_ID }}",
            "MAL_CLIENT_SECRET": "${{ secrets.MAL_CLIENT_SECRET }}",
            "API_URL": "${{ secrets.API_URL }}"
            "COMMENTUM_API_URL": "${{ secrets.COMMENTUM_API_URL }}"
          }
          EOF
      - run: flutter pub get
      - run: flutter build apk --release --split-per-abi --obfuscate --split-debug-info=build/app/outputs/symbols --dart-define-from-file=keys.json
      - uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/*.apk

  build-linux:
    if: github.event_name == 'push' || github.event.inputs.build_linux == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev webkit2gtk-4.1 libsecret-1-dev libasound2-dev libmpv-dev libwpewebkit-1.0-dev
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
      - name: Configure Env
        run:  |
          cat <<EOF > keys.json
          {
            "ANILIST_CLIENT_ID": "${{ secrets.ANILIST_CLIENT_ID }}",
            "ANILIST_CLIENT_SECRET": "${{ secrets.ANILIST_CLIENT_SECRET }}",
            "MAL_CLIENT_ID": "${{ secrets.MAL_CLIENT_ID }}",
            "MAL_CLIENT_SECRET": "${{ secrets.MAL_CLIENT_SECRET }}",
            "API_URL": "${{ secrets.API_URL }}"
            "COMMENTUM_API_URL": "${{ secrets.COMMENTUM_API_URL }}"
          }
          EOF
      - run: flutter pub get
      - run: flutter build linux --release --obfuscate --split-debug-info=build/linux/debug-info --dart-define-from-file=keys.json
      - run: |
          cd build/linux/x64/release/bundle
          zip -r ../../../../../ShonenX-Linux.zip .
      - uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: ShonenX-Linux.zip

  build-windows:
    if: github.event_name == 'push' || github.event.inputs.build_windows == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - run: git config --system core.longpaths true
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
      - name: Configure Env
        shell: bash
        run:  |
          cat <<EOF > keys.json
          {
            "ANILIST_CLIENT_ID": "${{ secrets.ANILIST_CLIENT_ID }}",
            "ANILIST_CLIENT_SECRET": "${{ secrets.ANILIST_CLIENT_SECRET }}",
            "MAL_CLIENT_ID": "${{ secrets.MAL_CLIENT_ID }}",
            "MAL_CLIENT_SECRET": "${{ secrets.MAL_CLIENT_SECRET }}",
            "API_URL": "${{ secrets.API_URL }}"
            "COMMENTUM_API_URL": "${{ secrets.COMMENTUM_API_URL }}"
          }
          EOF
      - run: flutter pub get
      - run: flutter build windows --release --obfuscate --split-debug-info=build/windows/debug-info --dart-define-from-file=keys.json
      - name: Generate Inno Script
        shell: pwsh
        run: |
          $pubspec = Get-Content pubspec.yaml -Raw
          $version = ([regex]::Match($pubspec, 'version:\s*([^\s+]+)')).Groups[1].Value
          $appId = ([regex]::Match($pubspec, 'id:\s*([^\s\n\r]+)')).Groups[1].Value
          $publisher = ([regex]::Match($pubspec, 'publisher:\s*([^\n\r]+)')).Groups[1].Value.Trim()
          $appName = ([regex]::Match($pubspec, 'name:\s*([^\n\r]+)', [System.Text.RegularExpressions.RegexOptions]::RightToLeft)).Groups[1].Value.Trim()
          $iss = @"
          [Setup]
          AppId={{$appId}}
          AppName=$appName
          AppVersion=$version
          AppPublisher=$publisher
          DefaultDirName={autopf}\$appName
          DefaultGroupName=$appName
          OutputDir=build\windows\x64\installer
          OutputBaseFilename=$appName-v$version-Setup
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesInstallIn64BitMode=x64

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

          [Files]
          Source: "build\windows\x64\runner\release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\$appName"; Filename: "{app}\shonenx.exe"
          Name: "{autodesktop}\$appName"; Filename: "{app}\shonenx.exe"; Tasks: desktopicon

          [Run]
          Filename: "{app}\shonenx.exe"; Description: "{cm:LaunchProgram,$appName}"; Flags: nowait postinstall skipifsilent
          "@
          $iss | Out-File -FilePath installer.iss -Encoding utf8
      - name: Compile Inno Setup
        run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss'
      - name: Create Portable Zip
        run: Compress-Archive -Path build\windows\x64\runner\release\* -DestinationPath ShonenX-Windows-Portable.zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows-dist
          path: |
            build/windows/x64/installer/*.exe
            ShonenX-Windows-Portable.zip

  publish-release:
    needs: [build-android, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Generate Changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          git log ${PREVIOUS_TAG:+$PREVIOUS_TAG..}HEAD --pretty=format:'%s' > all_commits.txt
          TAG_NAME=${GITHUB_REF_NAME}
          {
            echo "notes<<EOF"
            if [[ "$TAG_NAME" == *"debug"* ]]; then echo -e "> [!WARNING]\n> **DEBUG BUILD**";
            elif [[ "$TAG_NAME" == *"beta"* ]]; then echo -e "> [!IMPORTANT]\n> **BETA RELEASE**";
            elif [[ "$TAG_NAME" == *"alpha"* ]]; then echo -e "> [!CAUTION]\n> **ALPHA RELEASE**";
            elif [[ "$TAG_NAME" == *"hotfix"* ]]; then echo -e "> [!NOTE]\n> **HOTFIX RELEASE**"; fi
            echo -e "\n## Changelog"
            grep -iE "^(feat|fix|perf|refactor|chore)" all_commits.txt | sed "s/^/- /" || echo "No specific changes tracked."
            echo "EOF"
          } >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.apk
            artifacts/**/*.zip
            artifacts/**/*.exe
          body: ${{ steps.changelog.outputs.notes }}
          token: ${{ secrets.GITHUB_TOKEN }}