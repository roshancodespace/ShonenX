name: Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: 25.2.9519653

      - name: Install CMake 3.18.1
        run: |
          yes | sdkmanager "cmake;3.18.1"
          echo "cmake.dir=$ANDROID_HOME/cmake/3.18.1" >> android/local.properties

      - name: Install dependencies
        run: flutter pub get

      # ðŸ” ANDROID SIGNING (KEYSTORE)
      - name: Decode Android keystore
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore/upload-keystore.jks

      - name: Create key.properties
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=keystore/upload-keystore.jks
          EOF

      - name: Create .env file
        run: |
          echo "ANILIST_CLIENT_ID=${{ secrets.ANILIST_CLIENT_ID }}" >> .env
          echo "ANILIST_CLIENT_SECRET=${{ secrets.ANILIST_CLIENT_SECRET }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env

      - name: Build APK (split per ABI)
        run: flutter build apk --release --split-per-abi

      - name: Verify APK signing
        run: |
          for apk in build/app/outputs/flutter-apk/*.apk; do
            echo "Verifying $apk"
            apksigner verify --verbose "$apk"
          done

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/*.apk

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libwebkit2gtk-4.1-dev libsecret-1-dev \
            libasound2-dev libmpv-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.5"

      - name: Install dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          echo "ANILIST_CLIENT_ID=${{ secrets.ANILIST_CLIENT_ID }}" >> .env
          echo "ANILIST_CLIENT_SECRET=${{ secrets.ANILIST_CLIENT_SECRET }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env

      - name: Build Linux
        run: flutter build linux --release

      - name: Compress Linux Bundle
        run: |
          cd build/linux/x64/release/bundle
          zip -r ../../../../../ShonenX-Linux.zip .

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: ShonenX-Linux.zip

  publish-release:
    needs: [build-android, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apks
          path: android-apks

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: linux-bundle

      - name: Generate Changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            git log HEAD --pretty=format:'%s' > all_commits.txt
          else
            git log $PREVIOUS_TAG..HEAD --pretty=format:'%s' > all_commits.txt
          fi

          TAG_NAME=${GITHUB_REF_NAME}
          WARNING_MSG=""

          if [[ "$TAG_NAME" == *"debug"* ]]; then
            WARNING_MSG="> [!WARNING]\n> **DEBUG BUILD**"
          elif [[ "$TAG_NAME" == *"beta"* ]]; then
            WARNING_MSG="> [!IMPORTANT]\n> **BETA RELEASE**"
          elif [[ "$TAG_NAME" == *"alpha"* ]]; then
            WARNING_MSG="> [!CAUTION]\n> **ALPHA RELEASE**"
          elif [[ "$TAG_NAME" == *"hotfix"* ]]; then
            WARNING_MSG="> [!NOTE]\n> **HOTFIX RELEASE**"
          fi

          echo -e "$WARNING_MSG\n## Changelog" > release_notes.md

          grep -i "^feat" all_commits.txt | sed "s/^feat[: ]*/- /" >> release_notes.md || true
          grep -i "^fix" all_commits.txt | sed "s/^fix[: ]*/- /" >> release_notes.md || true
          grep -i "^perf" all_commits.txt | sed "s/^perf[: ]*/- /" >> release_notes.md || true
          grep -i "^refactor" all_commits.txt | sed "s/^refactor[: ]*/- /" >> release_notes.md || true
          grep -i "^chore" all_commits.txt | sed "s/^chore[: ]*/- /" >> release_notes.md || true

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-apks/*.apk
            linux-bundle/*.zip
          body: ${{ steps.changelog.outputs.notes }}
          token: ${{ secrets.GITHUB_TOKEN }}
